<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace:填写映射当前的Mapper接口，所有的增删改查的参数和返回值类型，
		就可以直接填写缩写，不区分大小写，直接通过方法名去找类型-->
<mapper namespace="cn.yugutou.reckoning.dao.mapper.BillingMapper">
    <!-- sql:里面可以写入一个共同的sql代码，用于提取重复的代码。
        要使用该代码的时候就直接使用<include>标签
        id:为提取的sql代码，取一个id，起标识作用
         -->
    <resultMap id="BaseRsultMap" type="cn.yugutou.reckoning.dao.entity.BillingInfo">
        <id column="billing_id" property="billingId" javaType="Long"/>
        <result column="amount" property="amount" javaType="BigDecimal"/>
        <result column="people_num" property="peopleNum" javaType="Integer"/>
        <result column="billing_status" property="billingStatus" javaType="String"/>
        <result column="allocation_method" property="allocationMethod" javaType="String"/>
        <!--<result column="apportioned_amount" property="apportionedAmount" javaType="BigDecimal"/>-->
        <result column="consumption_notes" property="consumptionNotes" javaType="String"/>
        <result column="consumer_address" property="consumerAddress" javaType="String"/>
        <result column="dissipate" property="dissipate" javaType="Date"/>
        <result column="create_time" property="createTime" javaType="Date"/>
        <result column="modify_time" property="modifyTime" javaType="Date"/>
    </resultMap>
    <sql id="selectAll">
        billing_id
        ,amount,people_num,billing_status,allocation_method,consumption_notes,consumer_address,dissipate,create_time,modify_time
    </sql>

    <!--新增账单-->
    <insert id="addBill" parameterType="cn.yugutou.reckoning.dao.entity.BillingInfo">
        insert into billing_info values
        (#{billingId},#{amount},#{peopleNum},#{billingStatus},#{allocationMethod},#{consumptionNotes},#{consumerAddress},#{createUserId},#{dissipate},now(),now(),#{billTheme});
        /*获取插入数据的主键*/
        <!--        <selectKey keyProperty="billingId" order="AFTER"  resultType="java.lang.Long">-->
        <!--            select LAST_INSERT_ID()-->
        <!--        </selectKey>-->
    </insert>


    <!--    查询账单详情-->
    <select id="findBillDetail" parameterType="map" resultMap="billDetail">

        SELECT
            a.billing_id,
            a.bill_theme,
            a.amount,
            a.people_num,
            a.billing_status,
            a.allocation_method,
            a.consumption_notes,
            a.consumer_address,
            a.create_user_id,
            a.dissipate,
            b.user_id,
            b.user_participation_type,
            b.apportioned_amount,
            b.payment_status
        FROM
            billing_info a
                LEFT JOIN usr_bill_association b ON a.billing_id = b.billing_id  where a.billing_id = #{billingId}
            and exists (select 1 from usr_bill_association c where c.billing_id =#{billingId}
            and c.user_id = #{userId})

    </select>
    <resultMap id="billDetail" type="queryBillDetailResp">
        <id column="billing_id" property="billingId" javaType="Long"/>
        <result column="amount" property="amount" javaType="BigDecimal"/>
        <result column="people_num" property="peopleNum" javaType="Integer"/>
        <result column="billing_status" property="billingStatus" javaType="String"/>
        <result column="allocation_method" property="allocationMethod" javaType="String"/>
        <result column="consumption_notes" property="consumptionNotes" javaType="String"/>
        <result column="consumer_address" property="consumerAddress" javaType="String"/>
        <result column="create_user_id" property="createUserId" javaType="Long"/>
        <result column="dissipate" property="dissipate" javaType="Date"/>
        <result column="bill_theme" property="billTheme" javaType="String"/>
        <collection property="conSumeList" ofType="consumeDetailResp">
            <id column="user_id" property="userId"></id>
            <id column="user_participation_type" property="userParticipationType"></id>
            <id column="apportioned_amount" property="apportionedAmount"></id>
            <id column="payment_status" property="paymentStatus"></id>
        </collection>
    </resultMap>

    <select id="queryUserBillingInfo" parameterType="queryBillingInfoReq" resultType="userBillingInfoResp"></select>


</mapper>
